---
layout: post
title: Filebeat를 이용한 MQTT 요청 로그 관리
tags: [ELK, Logging, MQTT]
comments: true
mathjax: true
author: 이희두
---


## 목적

- 특정 서비스에서 발생하는 **MQTT 요청 로그를 Elasticsearch에 인덱싱**하여  
  GUI 환경에서 **요청 흐름을 시각적으로 추적하고 분석**할 수 있도록 구성

---

## 사용 도구

**Filebeat**  
Elastic Stack의 경량 로그 수집기로, 로그 파일을 실시간으로 읽어  
전처리 후 Elasticsearch 또는 Logstash로 전송

---

## Filebeat를 사용한 이유 (vs Logstash)

- YAML 기반 설정으로 복잡한 파이프라인 없이도  
  JSON 디코딩, 필터링, 파싱이 가능
- Filebeat는 Go 기반 경량 프로세스로  
  Java 기반인 Logstash 대비 **리소스 사용량이 적음**

---

## Spring 로그 원본 예시

```text
[2025-03-25 00:35:29:62155153][MQTT Call: xxxxx] INFO  c.xxx.config.MqttConfiguration - recording : client/data/topic/123456789012345, msg: {...}
````

---

## Elasticsearch 저장 구조 예시

```json
{
  "_index": "mqtt_topic-2025.03.25",
  "_source": {
    "@timestamp": "2025-03-25T00:42:22.854Z",
    "imei": "123456789012345",
    "mqtt_topic": "client_data_topic",
    "recording_topic": "client_data_topic_123456789012345",
    "msg": "{...}",
    "receivedTimestamp": 1742862929000,
    "receivedTimestampFull": "2025-03-25 00:35:29:62155153",
    "agent": {
      "type": "filebeat",
      "version": "8.x"
    }
  }
}
```

---

## 로그 처리 흐름 요약

1. `/path/to/log/log_*.log` 형태로 저장된 로그 파일을 Filebeat가 감지
2. processor를 통해 **필드 분리 및 JSON 파싱**
3. 단말 식별자(예: IMEI) 추출
4. 토픽 정규화 (`recording_topic → mqtt_topic`)
5. 인덱스 명을 `mqtt_topic-yyyy.MM.dd` 포맷으로 생성
6. Elasticsearch에 저장
7. Kibana 등에서 필드 기반 검색 및 시각화

---

## processors 구성

### 처리 순서

1. ANSI 색상 코드 제거
2. `"recording :"`, `"msg:"`가 없는 이벤트는 drop
3. dissect를 이용한 고정 포맷 파싱

```text
[%{receivedTimestampFull}][%{}] INFO %{} - recording : %{recording_topic}, msg: %{msg}
```

4. JSON 디코딩
5. `receivedTimestamp`를 epoch(ms)로 변환 후 `@timestamp` 설정
6. 단말 식별자 추출
7. recording_topic 내 `/` → `_` 치환
   (Elasticsearch 인덱스명에 `/` 사용 불가)
8. recording_topic 기반으로 mqtt_topic 필드 생성
   (식별자 제외)
9. dissect 실패 이벤트 제거
10. 불필요한 필드 제거

---

## processors란?

* Filebeat가 로그 파일을 읽고 Elasticsearch로 전송하기 전 수행하는 **전처리 단계**
* 주요 기능:

  * 조건 필터링
  * 필드 파싱
  * JSON 디코딩
  * 스크립트 기반 필드 가공

---

## Elasticsearch 9.x 업그레이드 대응 사항

### 1. input 타입 변경

* `type: log` deprecated
* 아래와 같이 `filestream` 사용

```yaml
- type: filestream
  id: mqtt-log
```

---

### 2. 보안 설정 추가 (CA 인증서)

* 최신 Elasticsearch는 TLS 인증 필수
* Elasticsearch 노드의 CA 인증서를 Filebeat 서버로 복사

```yaml
ssl.certificate_authorities: ["/etc/filebeat/http_ca.crt"]
```

* `output.elasticsearch` 설정에 추가
* 동일 위치에 `username`, `password` 설정

---

## 참고 설정 파일

[filebeat.yml](/assets/file/filebeat.yaml)
[filebeat2.yaml](/assets/file/filebeat2.yaml)

(Elasticsearch 9.x 업그레이드 내용 반영)

```

---
