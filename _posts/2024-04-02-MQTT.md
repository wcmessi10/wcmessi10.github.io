---
layout: post
title: MQTT 프로토콜 정리
tags: [Message Protocol, IoT, Pub/Sub]
comments: true
mathjax: true
author: 이희두
---

## 1. MQTT 개요

MQTT(Message Queuing Telemetry Transport)는

> **저전력·저대역폭 환경의 IoT 디바이스를 위해 설계된 경량 메시징 프로토콜**입니다.

### 핵심 특징

* 경량 헤더(최소 2바이트) → 네트워크 사용량 최소화
* 저전력 디바이스 친화적
* 고지연·불안정 네트워크에서도 동작
* TCP/IP 기반 프로토콜
* Pub/Sub 모델 기반 비동기 통신

---

## 2. Pub/Sub 통신 모델

구조:

```
Publisher → Broker → Subscriber
```

### 특성

* Publisher와 Subscriber는 서로 직접 연결되지 않음 (Decoupling)
* 모든 메시지는 Broker를 통해서만 전달
* 1:N, N:N 통신 용이
* 시스템 확장성 우수

---

## 3. 연결지향(Connection-Oriented)

MQTT는 TCP 기반 연결지향 프로토콜입니다.

* 클라이언트는 Broker와 지속 연결 유지
* Keep Alive 메커니즘으로 연결 상태 점검
* 네트워크 장애 시 재연결 가능

주의:
MQTT는 **항상 연결을 유지하려는 설계**이지만, 실제 연결 안정성은 네트워크 환경에 의존합니다.

---

## 4. QoS (Quality of Service)

QoS는 **메시지 전달 보장 수준**을 의미합니다.

### QoS 0 — At most once

* 전달 보장 없음
* 재전송 없음
* 가장 빠름
* 데이터 손실 가능

적합: 센서 텔레메트리, 로그 스트림

---

### QoS 1 — At least once

* PUBACK 확인
* 실패 시 재전송
* 중복 가능성 존재

적합: 일반 IoT 데이터 전송

---

### QoS 2 — Exactly once

* 4단계 핸드셰이크
* 중복 없음
* 가장 높은 신뢰성
* 지연 증가

적합: 결제, 제어 명령, 상태 전환

---

중요 교정:

> “손실 없이 효율적으로 전달 보장”
> → MQTT가 자동 보장하는 것이 아니라 **QoS 설정에 따라 달라집니다.**

---

## 5. MQTT 동작 프로세스

1. TCP 연결 수립
2. Client → CONNECT 전송
3. Broker → CONNACK 응답
4. Publish/Subscribe 통신 시작

---

## 6. Topic

* 메시지 라우팅 채널
* 계층 구조 지원 (`/` 구분)

예:

```
station/23/swapBty
battery/+/soc
station/#
```

### 규칙 보완

* 최상위 토픽이 `/`로 시작하는 것은 **문법적으로 가능**
* 다만 일반적으로 권장되지 않음 (가독성/관리 측면)

### 와일드카드

* `+` : 한 단계 매칭
* `#` : 전체 하위 매칭

---

## 7. MQTT Packet 구조

### Fixed Header (필수)

* 패킷 타입
* 플래그
* Remaining Length

---

### Variable Header

* Packet Identifier
* Topic Name
* 옵션 필드

---

### Payload

* 실제 데이터
* 형식 제한 없음 (JSON, 바이너리 등)

# 결론

MQTT는 다음 환경에 최적화된 프로토콜입니다:

* IoT 네트워크
* 불안정한 무선 환경
* 대규모 디바이스 연결 관리
* 실시간 이벤트 기반 통신


