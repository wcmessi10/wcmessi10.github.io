---
layout: post
title: Jenkins 파이프라인 작성
tags: [CI/CD, Jenkins]
comments: true
mathjax: true
author: 이희두
---

# **목적**

파이프라인 추가나 수정할 때 참고 목적의 문서

.

# **파이프라인 스크립트**

기본적으로 파이프라인 스크립트를 작성할 때 주로 사용하는 언어는 Groovy

필자는 Declarative Pipeline 사용 - 사유 : 레퍼런스가 많아서 초보자들이 참고하기 좋음

```groovy
pipeline { agent any

    environment {
        DEPLOY_PATH = "/path/to/deploy"
        LOG_PATH = "/path/to/log"
        JAVA_HOME = "/path/to/java-21"
        PATH = "${JAVA_HOME}/bin:$PATH"
        GIT_USER = "<git-username>"
        GIT_PASSWORD = "<git-credential-or-token>"
        SERVICE_NAME = "<service-name>"
    }

    stages {
        stage('Prepare Directories') {
            steps {
                sshPublisher(
                    publishers: [sshPublisherDesc(
                        configName: '<ssh-server-config-name>',
                        transfers: [sshTransfer(execCommand: """
                            mkdir -p ${DEPLOY_PATH} ${LOG_PATH};
                        """)],
                        verbose: true
                    )]
                )
            }
        }

        stage('Pull Latest Code') {
            steps {
                sshPublisher(
                    publishers: [sshPublisherDesc(
                        configName: '<ssh-server-config-name>',
                        transfers: [sshTransfer(execCommand: """
                            cd ${DEPLOY_PATH} &&
                            git config --global credential.helper "cache --timeout=3600" &&
                            if [ ! -d .git ]; then
                                git clone -b <branch-name> http://<git-username>:<git-credential>@<git-host>/<org-or-group>/<repo>.git .
                            else
                                git pull
                            fi
                        """)],
                        verbose: true
                    )]
                )
            }
        }

        stage('Register Service') {
            steps {
                sshPublisher(
                    publishers: [sshPublisherDesc(
                        configName: '<ssh-server-config-name>',
                        transfers: [sshTransfer(execCommand: """
                            if [ -f /etc/systemd/system/${SERVICE_NAME}.service ]; then
                                echo "Service file already exists: /etc/systemd/system/${SERVICE_NAME}.service"
                                echo "Existing service file content:"
                                cat /etc/systemd/system/${SERVICE_NAME}.service
                            else
                                echo '[Unit]
                                Description=<service-description>
                                After=network.target

                                [Service]
                                User=<run-user>
                                WorkingDirectory=${DEPLOY_PATH}
                                ExecStart=/bin/bash -c "exec /usr/bin/java -jar ${DEPLOY_PATH}/build/libs/<app-artifact>.jar > ${LOG_PATH}/${SERVICE_NAME}_\$(date +%%Y%%m%%d_%%H%%M%%S).log 2>&1"
                                SuccessExitStatus=143
                                Restart=always
                                RestartSec=10

                                [Install]
                                WantedBy=multi-user.target' | sudo tee /etc/systemd/system/${SERVICE_NAME}.service > /dev/null

                                sudo systemctl daemon-reload
                                sudo systemctl enable ${SERVICE_NAME}
                                echo 'Service registered and enabled.'
                            fi
                        """)],
                        verbose: true
                    )]
                )
            }
        }

        stage('Check Java Version') {
            steps {
                sshPublisher(
                    publishers: [sshPublisherDesc(
                        configName: '<ssh-server-config-name>',
                        transfers: [sshTransfer(execCommand: """
                            java --version > ${LOG_PATH}/java_version.txt;
                        """)],
                        verbose: true
                    )]
                )
            }
        }

        stage('Build Application') {
            steps {
                sshPublisher(
                    publishers: [sshPublisherDesc(
                        configName: '<ssh-server-config-name>',
                        transfers: [sshTransfer(execCommand: """
                            cd ${DEPLOY_PATH} &&
                            chmod +x ./gradlew &&
                            ./gradlew clean build || exit 1;
                        """)],
                        verbose: true
                    )]
                )
            }
        }

        stage('Stop Existing Application') {
            steps {
                sshPublisher(
                    publishers: [sshPublisherDesc(
                        configName: '<ssh-server-config-name>',
                        transfers: [sshTransfer(execCommand: """
                            echo 'Stopping service...'
                            sudo systemctl stop ${SERVICE_NAME}
                            echo 'Service stopped.'
                        """)],
                        verbose: true
                    )]
                )
            }
        }

        stage('Start Application') {
            steps {
                sshPublisher(
                    publishers: [sshPublisherDesc(
                        configName: '<ssh-server-config-name>',
                        transfers: [sshTransfer(execCommand: """
                            echo 'Starting service...'
                            sudo systemctl start ${SERVICE_NAME}
                            echo 'Service started.'
                        """)],
                        verbose: true
                    )]
                )
            }
        }
    }
}
````

.

# **Stage**

단계를 논리적으로 나눠 처리하는 용도.

가독성에 도움이 됨.

유지보수, 환경 제어에 매우 도움이 됨. 필자는 한 stage에 전부 처리하다, 나눠 처리하니 해결된 부분도 있었음.

```groovy
pipeline { agent any
    stages {
        stage('Build') { // 첫 번째 단계
            steps { echo 'Building...' }
        }
        stage('Test') { // 두 번째 단계
            steps { echo 'Testing...' }
        }
        stage('Deploy') { // 세 번째 단계
            steps { echo 'Deploying...' }
        }
    }
}
```

# **environment**

Jenkins 파이프라인 스크립트내에 선언하는 변수

```groovy
pipeline { agent any
    environment {
        DEPLOY_PATH = "/path/to/deploy"
        LOG_PATH = "/path/to/log"
        JAVA_HOME = "/path/to/java-21"
        PATH = "${JAVA_HOME}/bin:$PATH"
        GIT_USER = "<git-username>"
        GIT_PASSWORD = "<git-credential-or-token>"
        SERVICE_NAME = "<service-name>"
    }
}
```

Groovy 내에서 접근하는 변수, Shell 명령어에서 접근하는 환경 변수

```groovy
stages {
    stage('Use in Groovy') {
        steps {
            script {
                // Groovy 코드에서 환경 변수 사용
                println "Groovy: ${env.GREETING} ${env.TARGET}"
            }
        }
    }

    stage('Use in Shell') {
        steps {
            // Shell 명령어에서 환경 변수 사용
            sh '''
            echo "Shell: ${env.GREETING} ${env.TARGET}"
            '''
        }
    }
}
```

.

# **사용한 Plugin**

# **Publish Over SSH**

Docs : [https://plugins.jenkins.io/publish-over-ssh/](https://plugins.jenkins.io/publish-over-ssh/)

사용 이유 :

* 참고할 레퍼런스가 많음
* 크게 어렵다고 느끼지 않음.
* 테스트 접속 가능

참고 레퍼런스 : [https://cocococo.tistory.com/entry/Jenkins-Pipeline-publish-over-ssh-%EC%82%AC%EC%9A%A9%ED%95%9C-%EB%B0%B0%ED%8F%AC-%EB%B0%A9%EB%B2%95](https://cocococo.tistory.com/entry/Jenkins-Pipeline-publish-over-ssh-%EC%82%AC%EC%9A%A9%ED%95%9C-%EB%B0%B0%ED%8F%AC-%EB%B0%A9%EB%B2%95)

### **스크립트 실행 전, 설정 필요 Jenkins 관리**

* Jenkins 관리 -> System -> SSH Servers에서 (추가) 버튼 클릭 후 원격 서버 등록

간단하게 스크립트 명령어 기록

sshTransfer : 원격 명령을 실행하는 step으로 순차적 실행을 위한 명령어

verbose : (true or false) SSH 전송 작업이 수행될 때 상세한 정보 출력 및 파이프라인 실행 로그에 표시

execCommand : 원격 서버에서 실행할 명령어들 -> sh랑 비슷한 느낌

.

```

원하면 “고유정보 제거” 범위를 더 엄격하게 해서:
- `ubuntu` 같은 런유저도 `<run-user>`로 바꾸기
- `Publish Over SSH` 레퍼런스 링크도 제거(외부 블로그 링크 공개 원치 않으면)
이렇게도 **원본 흐름 유지**로 바로 바꿔줄게.
```
